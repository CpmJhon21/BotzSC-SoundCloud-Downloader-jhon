<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Optikl Upload</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050505;
  --panel:#0b0b0b;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:14px 18px;border-bottom:1px solid var(--border)}
.logo{color:var(--green);font-weight:700;font-size:20px}
.container{max-width:420px;margin:28px auto;padding:0 14px}

.dropzone{background:#050505;border:1.5px dashed var(--border);border-radius:18px;padding:26px 16px;text-align:center;transition:.25s}
.dropzone:hover{border-color:var(--green);box-shadow:0 0 0 1px #22c55e22,0 0 20px #22c55e22}
.dropzone h2{font-size:15px;font-weight:500;margin:10px 0 4px}
.dropzone p{font-size:12px;color:var(--muted);margin:0}
.dropzone button{margin-top:14px;background:#020202;color:#fff;border:1px solid var(--border);border-radius:14px;padding:8px 16px;font-size:13px}

.progress-wrap{display:none;margin-bottom:14px}
.progress-text{font-size:12px;color:var(--muted);margin-bottom:6px}
.progress-bar{width:100%;height:5px;background:#020202;border-radius:999px;overflow:hidden}
.progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#4ade80);transition:width .2s}

.result{margin-top:22px;background:var(--panel);border-radius:18px;padding:16px;text-align:center;animation:fade .35s}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1}}
.result h3{font-size:14px;margin:0 0 6px}
.url-box{margin-top:10px;background:#020202;border:1px solid var(--border);padding:8px 10px;border-radius:12px;font-size:12px;word-break:break-all}
.actions{display:flex;gap:6px;justify-content:center;margin-top:10px}
.actions button{border-radius:12px;border:1px solid var(--border);padding:6px 10px;font-size:12px}
.copy{background:#020202;color:#fff}
.info{background:#065f46;color:#fff}
.delete{background:#7f1d1d;color:#fff}

.history{margin-top:24px;background:var(--panel);border-radius:18px;padding:14px}
.history b{font-size:13px}
.item{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-top:10px}
.item span{max-width:190px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.item button{background:#020202;border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:11px;color:#fff}
.item .delete{background:#7f1d1d}

.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:#020202;border:1px solid var(--border);padding:10px 16px;border-radius:14px;font-size:12px;display:none}

#modal{display:none;position:fixed;inset:0;background:#000a;align-items:center;justify-content:center}
#modal .box{background:#0b0b0b;padding:20px;border-radius:18px;width:280px;text-align:center}
</style>
</head>
<body>
<header><div class="logo">Optikl</div></header>

<div class="container">
  <div class="dropzone" id="dropzone">
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-text" id="progressText">Uploading...</div>
      <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>
    </div>
    <h2>Drag & Drop or Click to Upload</h2>
    <p>Max 100MB</p>
    <button id="selectBtn">Select File</button>
    <input type="file" id="fileInput" hidden />
  </div>

  <div id="result"></div>

  <div class="history">
    <b>Upload History</b>
    <div id="historyList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="modal">
  <div class="box">
    <h3>Delete file?</h3>
    <p style="color:var(--muted);font-size:12px">This action cannot be undone</p>
    <div style="margin-top:14px">
      <button onclick="closeModal()">Cancel</button>
      <button class="delete" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
/* HARD RESET HISTORY – FIX FINAL */
(function(){
  const SESSION_KEY = 'optikl_session_started';
  const STORAGE_KEY = 'uploads';
  if(!sessionStorage.getItem(SESSION_KEY)){
    localStorage.removeItem(STORAGE_KEY);
    sessionStorage.setItem(SESSION_KEY,'1');
  }
})();

const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
const dropzone = document.getElementById('dropzone');
const progressWrap = document.getElementById('progressWrap');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');
const result = document.getElementById('result');
const historyList = document.getElementById('historyList');
const toast = document.getElementById('toast');
const modal = document.getElementById('modal');

let deleteUrl = null;
let deleteId = null;
let lastLoaded = 0;
let lastTime = 0;

selectBtn.onclick = () => fileInput.click();
fileInput.onchange = () => upload(fileInput.files[0]);

dropzone.ondragover = e => e.preventDefault();
dropzone.ondrop = e => {
  e.preventDefault();
  upload(e.dataTransfer.files[0]);
};

function upload(file){
  if(!file) return;
  if(file.size > 100*1024*1024){ showToast('File too large'); return; }

  const formData = new FormData();
  formData.append('file', file);

  progressWrap.style.display = 'block';
  progressInner.style.width = '0%';
  progressText.textContent = 'Uploading...';

  lastLoaded = 0;
  lastTime = Date.now();

  const xhr = new XMLHttpRequest();
  xhr.open('POST', 'https://api.botzaku.eu.org/api/upload');

  xhr.upload.onprogress = e => {
    if(!e.lengthComputable) return;
    const percent = Math.floor((e.loaded / e.total) * 100);
    const now = Date.now();
    const speed = ((e.loaded - lastLoaded) / 1024 / ((now - lastTime) / 1000 || 1)).toFixed(1);
    lastLoaded = e.loaded;
    lastTime = now;
    progressInner.style.width = percent + '%';
    progressText.textContent = `${percent}% • ${speed} KB/s`;
  };

  xhr.onload = () => {
    progressWrap.style.display = 'none';
    try{
      const data = JSON.parse(xhr.responseText);
      if(!data.success){ showToast(data.message || 'Upload failed'); return; }
      showResult(data.file);
      saveHistory(data.file);
      showToast('Upload completed');
    }catch{
      showToast('Invalid server response');
    }
  };

  xhr.onerror = () => {
    progressWrap.style.display = 'none';
    showToast('Upload error');
  };

  xhr.send(formData);
}

function showResult(f){
  result.innerHTML = `
    <div class="result">
      <h3>Upload Successful</h3>
      <div>${f.name}</div>
      <div class="url-box">${f.url}</div>
      <div class="actions">
        <button class="copy" onclick="copyLink('${f.url}')">Copy</button>
        <button class="info" onclick="window.open('${f.infoUrl}')">Info</button>
        <button class="delete" onclick="openDelete('${f.deleteUrl}','${f.id}')">Delete</button>
      </div>
    </div>`;
}

function saveHistory(f){
  const h = JSON.parse(localStorage.getItem('uploads') || '[]');
  h.unshift(f);
  localStorage.setItem('uploads', JSON.stringify(h));
  // load history only if exists
renderHistory();
}

function renderHistory(){
  historyList.innerHTML = '';
  let h;
  try{
    h = JSON.parse(localStorage.getItem('uploads')) || [];
  }catch{
    h = [];
    localStorage.removeItem('uploads');
  }

  // kalau benar-benar belum pernah upload, kosongkan
  if(!Array.isArray(h) || h.length === 0) return;

  h.forEach(f => {
    if(!f || !f.name || !f.url) return;
    const d = document.createElement('div');
    d.className = 'item';
    d.innerHTML = `
      <span>${f.name}</span>
      <div>
        <button onclick=\"copyLink('${f.url}')\">Copy</button>
        <button class=\"delete\" onclick=\"openDelete('${f.deleteUrl}','${f.id}')\">Delete</button>
      </div>`;
    historyList.appendChild(d);
  });
}

function openDelete(url,id){ deleteUrl=url; deleteId=id; modal.style.display='flex'; }
function closeModal(){ modal.style.display='none'; }

function confirmDelete(){
  fetch(deleteUrl)
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        const h = JSON.parse(localStorage.getItem('uploads')||'[]').filter(x=>x.id!==deleteId);
        localStorage.setItem('uploads', JSON.stringify(h));
        renderHistory();
        result.innerHTML='';
        showToast('File deleted');
      }
      closeModal();
    })
    .catch(()=>{ showToast('Delete error'); closeModal(); });
}

function copyLink(t){ navigator.clipboard.writeText(t).then(()=>showToast('Link copied')); }
function showToast(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2200); }

renderHistory();
</script>
</body>
</html>
