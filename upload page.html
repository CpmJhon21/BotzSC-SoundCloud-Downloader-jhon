<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Optikl Upload</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050505;
  --panel:#0b0b0b;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --green-soft:#22c55e33;
  --red:#ef4444;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}

header{
  height:56px;
  display:flex;
  align-items:center;
  padding:0 18px;
  border-bottom:1px solid var(--border)
}
.logo{color:var(--green);font-weight:700;font-size:20px}

.container{
  max-width:420px;
  margin:0 auto;
  padding:24px 14px 80px
}

.dropzone{
  background:#050505;
  border:2px dashed var(--border);
  border-radius:20px;
  padding:34px 16px;
  text-align:center;
  transition:.25s;
}
.dropzone:hover{
  border-color:var(--green);
  box-shadow:0 0 0 1px var(--green-soft),0 0 26px var(--green-soft)
}
.dropzone h2{
  font-size:15px;
  font-weight:500;
  margin:14px 0 6px
}
.dropzone p{
  font-size:12px;
  color:var(--muted);
  margin:0
}
.dropzone button{
  margin-top:16px;
  background:#020202;
  color:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:9px 18px;
  font-size:13px
}

.progress-wrap{display:none;margin-bottom:18px}
.progress-text{font-size:12px;color:var(--muted);margin-bottom:8px}
.progress-bar{
  width:100%;
  height:6px;
  background:#020202;
  border-radius:999px;
  overflow:hidden
}
.progress-inner{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#4ade80);
  transition:width .2s
}

.result{
  margin-top:26px;
  background:var(--panel);
  border-radius:20px;
  padding:18px;
  text-align:center;
  animation:fade .35s
}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1}}
.result h3{font-size:14px;margin:0 0 6px}
.result .filename{font-size:12px;color:var(--muted)}

.url-box{
  margin-top:12px;
  background:#020202;
  border:1px solid var(--border);
  padding:10px 12px;
  border-radius:14px;
  font-size:12px;
  word-break:break-all
}

.actions{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-top:14px
}
.actions button{
  border-radius:12px;
  border:1px solid var(--border);
  padding:7px 12px;
  font-size:12px
}
.copy{background:#020202;color:#fff}
.info{background:#065f46;color:#fff}
.delete{background:#7f1d1d;color:#fff}

.history{
  margin-top:26px;
  background:var(--panel);
  border-radius:20px;
  padding:16px
}
.history b{font-size:13px}

.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:12px;
  margin-top:12px
}
.item span{
  max-width:190px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap
}
.item button{
  background:#020202;
  border:1px solid var(--border);
  border-radius:10px;
  padding:4px 8px;
  font-size:11px;
  color:#fff
}
.item .delete{background:#7f1d1d}

.toast{
  position:fixed;
  bottom:22px;
  left:50%;
  transform:translateX(-50%);
  background:#020202;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:14px;
  font-size:12px;
  display:none
}

#modal{
  display:none;
  position:fixed;
  inset:0;
  background:#000a;
  align-items:center;
  justify-content:center
}
#modal .box{
  background:#0b0b0b;
  padding:22px;
  border-radius:20px;
  width:280px;
  text-align:center
}
</style>
</head>
<body>
<header><div class="logo">Optikl</div></header>

<div class="container">
  <div class="dropzone" id="dropzone">
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-text" id="progressText">Uploading...</div>
      <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>
    </div>
    <h2>Drag & Drop or Click to Upload</h2>
    <p>Max 100MB</p>
    <button id="selectBtn">Select File</button>
    <input type="file" id="fileInput" hidden />
  </div>

  <div id="preview" style="display:none;margin-top:18px;text-align:center"></div>

  <div id="result"></div>

  <div class="history">
    <b>Upload History</b>
    <div id="historyList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="infoModal" style="display:none;position:fixed;inset:0;background:#000a;align-items:center;justify-content:center">
  <div class="box" style="background:#0b0b0b;padding:20px;border-radius:18px;width:300px;text-align:left">
    <h3 style="margin-top:0">File Info</h3>
    <div id="infoPreview" style="margin-bottom:12px"></div>
    <div id="infoContent" style="font-size:12px;color:var(--muted);word-break:break-word;overflow-wrap:anywhere;max-height:220px;overflow:auto"></div>
    <div style="text-align:right;margin-top:14px">
      <button onclick="closeInfo()">Close</button>
    </div>
  </div>
</div>

<div id="modal">
  <div class="box">
    <h3>Delete file?</h3>
    <p style="color:var(--muted);font-size:12px">This action cannot be undone</p>
    <div style="margin-top:16px;display:flex;gap:10px;justify-content:center">
      <button onclick="closeModal()">Cancel</button>
      <button class="delete" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
/* HARD RESET HISTORY – FIX FINAL */
(function(){
  const SESSION_KEY = 'optikl_session_started';
  const STORAGE_KEY = 'uploads';
  if(!sessionStorage.getItem(SESSION_KEY)){
    localStorage.removeItem(STORAGE_KEY);
    sessionStorage.setItem(SESSION_KEY,'1');
  }
})();

const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
const dropzone = document.getElementById('dropzone');
const progressWrap = document.getElementById('progressWrap');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');
const preview = document.getElementById('preview');
const result = document.getElementById('result');
const historyList = document.getElementById('historyList');
const toast = document.getElementById('toast');
const modal = document.getElementById('modal');

let deleteUrl=null, deleteId=null, lastLoaded=0, lastTime=0;

selectBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>upload(fileInput.files[0]);
dropzone.ondragover=e=>e.preventDefault();
dropzone.ondrop=e=>{e.preventDefault();upload(e.dataTransfer.files[0])};

function upload(file){
  previewFile(file);

  if(!file) return;
  if(file.size>100*1024*1024){showToast('File too large');return}
  const fd=new FormData();fd.append('file',file);
  progressWrap.style.display='block';
  progressInner.style.width='0%';
  lastLoaded=0;lastTime=Date.now();
  const xhr=new XMLHttpRequest();
  xhr.open('POST','https://api.botzaku.eu.org/api/upload');
  xhr.upload.onprogress=e=>{
    if(!e.lengthComputable)return;
    const p=Math.floor(e.loaded/e.total*100);
    const now=Date.now();
    const sp=((e.loaded-lastLoaded)/1024/((now-lastTime)/1000||1)).toFixed(1);
    lastLoaded=e.loaded;lastTime=now;
    progressInner.style.width=p+'%';
    progressText.textContent=`${p}% • ${sp} KB/s`;
  };
  xhr.onload=()=>{
    progressWrap.style.display='none';
    try{
      const d=JSON.parse(xhr.responseText);
      if(!d.success){showToast(d.message||'Upload failed');return}
      showResult(d.file);saveHistory(d.file);showToast('Upload completed');
    }catch{showToast('Invalid response')}
  };
  xhr.onerror=()=>{progressWrap.style.display='none';showToast('Upload error')};
  xhr.send(fd);
}

preview.style.display='none';
function showResult(f){
  result.innerHTML=`<div class="result"><h3>Upload Successful</h3><div class="filename">${f.name}</div><div class="url-box">${f.url}</div><div class="actions"><button class="copy" onclick="copyLink('${f.url}')">Copy</button><button class="info" onclick="openInfo('${f.infoUrl}')">Info</button><button class="delete" onclick="openDelete('${f.deleteUrl}','${f.id}')">Delete</button></div></div>`
}

function saveHistory(f){
  const h=JSON.parse(localStorage.getItem('uploads')||'[]');
  h.unshift(f);localStorage.setItem('uploads',JSON.stringify(h));renderHistory();
}

function renderHistory(){
  historyList.innerHTML='';
  const h=JSON.parse(localStorage.getItem('uploads')||'[]');
  if(!h.length) return;
  h.forEach(f=>{
    const d=document.createElement('div');d.className='item';
    d.innerHTML=`<span>${f.name}</span><div><button onclick=\"copyLink('${f.url}')\">Copy</button><button class=\"delete\" onclick=\"openDelete('${f.deleteUrl}','${f.id}')\">Delete</button></div>`;
    historyList.appendChild(d);
  })
}

function openDelete(u,i){deleteUrl=u;deleteId=i;modal.style.display='flex'}
function closeModal(){modal.style.display='none'}
function confirmDelete(){
  fetch(deleteUrl)
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        const h=JSON.parse(localStorage.getItem('uploads')||'[]').filter(x=>x.id!==deleteId);
        localStorage.setItem('uploads',JSON.stringify(h));
        renderHistory();
        result.innerHTML='';
        if(preview){ preview.innerHTML=''; preview.style.display='none'; }
        showToast('File deleted');
      }
      closeModal();
    })
    .catch(()=>{ showToast('Delete error'); closeModal(); });
}

function previewFile(file){
  if(!file) return;
  const type = file.type;
  preview.innerHTML = '';
  if(type.startsWith('image/')){
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.style.maxWidth = '100%';
    img.style.borderRadius = '16px';
    preview.appendChild(img);
    preview.style.display = 'block';
  }else if(type.startsWith('video/')){
    const v = document.createElement('video');
    v.src = URL.createObjectURL(file);
    v.controls = true;
    v.style.maxWidth = '100%';
    v.style.borderRadius = '16px';
    preview.appendChild(v);
    preview.style.display = 'block';
  }else{
    preview.style.display = 'none';
  }
}

function copyLink(t){navigator.clipboard.writeText(t).then(()=>showToast('Link copied'))}
function openInfo(url){
  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(!d.success) return showToast('Failed to load info');
      const f=d.file;
      const p=document.getElementById('infoPreview');
      p.innerHTML='';
      if(f.mimeType && f.mimeType.startsWith('image/')){
        const img=document.createElement('img');
        img.src=f.url;
        img.style.width='100%';
        img.style.borderRadius='14px';
        p.appendChild(img);
      }
      document.getElementById('infoContent').innerHTML=`
        <div><b>Name:</b> ${f.name}</div>
        <div><b>Size:</b> ${formatSize(f.size)}</div>
        <div><b>Type:</b> ${f.mimeType}</div>
        <div><b>Uploaded:</b> ${new Date(f.createdTime).toLocaleString()}</div>
        <div style="margin-top:6px"><b>URL:</b><div style="background:#020202;border:1px solid var(--border);padding:8px;border-radius:10px;font-size:11px;word-break:break-all">${f.url}</div></div>
      `;
      document.getElementById('infoModal').style.display='flex';
    })
    .catch(()=>showToast('Info error'));
}
function formatSize(s){const n=Number(s);if(n>1024*1024)return (n/1024/1024).toFixed(2)+' MB';if(n>1024)return (n/1024).toFixed(1)+' KB';return n+' B';}
function closeInfo(){document.getElementById('infoModal').style.display='none'}{
  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(!d.success) return showToast('Failed to load info');
      const f=d.file;
      document.getElementById('infoContent').innerHTML=`
        <div><b>Name:</b> ${f.name}</div>
        <div><b>Size:</b> ${f.size} bytes</div>
        <div><b>Type:</b> ${f.mimeType}</div>
        <div><b>Uploaded:</b> ${new Date(f.createdTime).toLocaleString()}</div>
        <div style="margin-top:6px"><b>URL:</b><div style="background:#020202;border:1px solid var(--border);padding:8px;border-radius:10px;font-size:11px;word-break:break-all">${f.url}</div></div>
      `;
      document.getElementById('infoModal').style.display='flex';
    })
    .catch(()=>showToast('Info error'));
}
function closeInfo(){document.getElementById('infoModal').style.display='none'}

function showToast(t){toast.textContent=t;toast.style.display='block';setTimeout(()=>toast.style.display='none',2200)}

renderHistory();
</script>
</body>
</html>
